name: Patch inbox (comments or issue body)

on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  apply:
    if: >
      github.event.issue.pull_request == null &&
      ((github.event_name == 'issue_comment' && contains(github.event.comment.body, '/apply')) ||
       (github.event_name == 'issues'        && contains(github.event.issue.body,   '/apply')))
    runs-on: ubuntu-latest
    env:
      PR_BRANCH: apply/${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Extract patch to patch.diff
        env:
          BODY: ${{ github.event_name == 'issue_comment' && github.event.comment.body || github.event.issue.body }}
        run: |
          set -e
          python - <<'PY'
          import os, re, base64, sys
          body = os.environ.get('BODY','')
          m = re.search(r"```(?:diff|patch)\n(.*?)```", body, re.S)
          data = m.group(1).encode('utf-8') if m else None
          if not data:
            m = re.search(r"```base64\n(.*?)```", body, re.S)
            data = base64.b64decode(m.group(1).strip()) if m else None
          if not data:
            print("::error::No ```diff/patch``` or ```base64``` fenced block found"); sys.exit(1)
          text = data.decode('utf-8','replace').replace('\r\n','\n').replace('\r','\n')
          if not text.endswith('\n'): text += '\n'
          open('patch.diff','w',encoding='utf-8').write(text)
          PY

      - name: Show first 40 lines (debug)
        run: nl -ba patch.diff | sed -n '1,40p'

      - name: Apply patch and push branch
        run: |
          set -eux
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$PR_BRANCH"
          if ! git apply -p0 --whitespace=fix --index patch.diff; then
            git reset --hard
            git apply -p1 --whitespace=fix --index patch.diff
          fi
          git commit -m "Apply patch from ${{ github.event_name }}: ${{ github.event.issue.html_url || github.event.comment.html_url }}" || echo "Nothing to commit"
          git push --set-upstream origin "$PR_BRANCH"

      - name: Create PR
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          base:   ${{ github.event.repository.default_branch }}
          branch: ${{ env.PR_BRANCH }}
          title:  "Auto patch from issue #${{ github.event.issue.number }}"
          body:   "Applied patch from **${{ github.event_name }}**. Source: ${{ github.event.comment.html_url || github.event.issue.html_url }}"
          delete-branch: true

      - name: Reply with PR link (best-effort)
        if: steps.cpr.outputs.pull-request-url != ''
        continue-on-error: true
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: "âœ… Patch applied. Open PR: ${{ steps.cpr.outputs.pull-request-url }}"