<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aethelred — Live Signals & Metrics</title>
<style>
  :root { --bg:#0f141a; --card:#171c22; --soft:#212a33; --muted:#90a0b4; --text:#d7e0ea; --accent:#87d7ff; --good:#2ecc71; --bad:#ff6b6b; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1280px;margin:0 auto;padding:20px}
  .row{display:grid;gap:16px}
  .row.top{grid-template-columns:2fr 1fr}
  .row.cards{grid-template-columns:repeat(3,1fr)}
  @media (max-width:1100px){.row.cards{grid-template-columns:1fr}.row.top{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #223041;border-radius:14px;padding:18px}
  .title{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:700;margin-bottom:16px}
  .dot{width:10px;height:10px;border-radius:50%;background:#6be4ff;box-shadow:0 0 10px #6be4ff}
  .chip{display:inline-block;padding:6px 10px;border-radius:12px;border:1px solid #2a3b4e;background:#10161d;color:#90a0b4;font-size:12px}
  .chip.good{border-color:#224c3a;color:#a9eec8;background:#0f1a14}
  .chip.bad{border-color:#5b2d2d;color:#ffc3c3;background:#1a1010}
  .h1{font-size:36px;font-weight:800;letter-spacing:.2px}
  .muted{color:#90a0b4}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px 18px}
  .grid2 .k{color:#90a0b4}
  .grid2 .v{text-align:right;font-variant-numeric:tabular-nums}
  .footer{margin-top:8px;color:#90a0b4;font-size:12px}
  .controls{display:flex;align-items:center;gap:10px;margin:10px 0 18px}
  select,button{background:#121a22;color:var(--text);border:1px solid #263647;border-radius:10px;padding:8px 10px}
  button.primary{background:#133044;border-color:#1b4a66}
  button:hover{filter:brightness(1.06)}
  .pnl-pos{color:var(--good);font-weight:600}
  .pnl-neg{color:var(--bad);font-weight:600}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:999}
  .modal{width:min(1100px,95vw);background:#171c22;border:1px solid #233243;border-radius:14px;overflow:hidden}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#10171f;border-bottom:1px solid #1f2c3a}
  .modal h3{margin:0;font-size:18px}
  .modal .body{padding:14px 16px;max-height:70vh;overflow:auto}
  .modal .foot{padding:12px 16px;border-top:1px solid #1f2c3a;background:#10171f;text-align:right}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #223041;text-align:left}
  th{color:#90a0b4;font-weight:600;position:sticky;top:0;background:#10161d}
  td.num{text-align:right;font-variant-numeric:tabular-nums}
  .side-long{color:#9fe7c1}
  .side-short{color:#ffb3b3}
  .section-title{margin:8px 0 6px;font-weight:700}
    .modal .content {
    max-width: 1100px;
    margin: 0 auto;            /* centers the content horizontally */
  }
  .table-wrap {
    width: 100%;
    display: grid;
    place-items: center;       /* centers tables */
  }
  .table-wrap table {
    width: 96%;
    margin: 0 auto;
  }
</style>
</head>
<body>
<canvas id="equitySpark" height="40" style="width:100%;"></canvas>
<div class="wrap">
  <div class="title"><span class="dot"></span> Aethelred — Live Signals & Metrics</div>

  <div class="controls">
    <span class="muted">Refresh every</span>
    <select id="refreshSel">
      <option value="15">15s</option>
      <option value="30">30s</option>
      <option value="60" selected>60s</option>
      <option value="120">2m</option>
    </select>
    <button id="btnRefresh">Refresh now</button>
    <button id="btnTrades" class="primary">Last 24h trades</button>
  </div>

  <div class="row top">
    <div class="card">
      <div class="muted">Total paper equity</div>
      <div id="equityTotal" class="h1">—</div>
      <div id="equityDelta" class="muted">Δ 24h: —</div>
    </div>
    <div class="card">
      <div class="muted">Bots contributing</div>
      <div id="botsCount" class="h1">—</div>
      <div id="botsTime" class="muted">—</div>
    </div>
  </div>

  <div id="cards" class="row cards" style="margin-top:16px;"></div>

  <div class="footer muted" style="margin-top:12px;">Updated via /signals and /metrics endpoints.</div>
</div>

<!-- Trades modal -->
<div id="tradesBackdrop" class="modal-backdrop">
  <div class="modal">
    <header>
      <h3>Trades & positions (last 24h)</h3>
      <button id="btnCloseTrades">Close</button>
    </header>
    <div class="body">
      <div class="muted" id="tradesSummary">Loading…</div>

      <div class="section-title">Closed trades</div>
      <div style="overflow:auto; margin-bottom:10px;">
        <table id="tradesTable">
          <thead>
            <tr>
              <th>Pair</th>
              <th>Side</th>
              <th>Entry time</th>
              <th class="num">Entry</th>
              <th>Exit time</th>
              <th class="num">Exit</th>
              <th class="num">%PnL</th>
              <th class="num">Holding</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button id="btnExportTrades">Export closed CSV</button>

      <div class="section-title" style="margin-top:14px;">Open positions</div>
      <div style="overflow:auto;">
        <table id="openTable">
          <thead>
            <tr>
              <th>Pair</th>
              <th>Side</th>
              <th>Entry time</th>
              <th class="num">Entry</th>
              <th class="num">Current</th>
              <th class="num">Unrealized %</th>
              <th class="num">Holding</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button id="btnExportOpen" style="margin-top:8px;">Export open CSV</button>
    </div>
    <div class="foot">
      <button id="btnCloseTrades2">Close</button>
    </div>
  </div>
</div>

<script>
// index.html (in renderCard)
const tradesLookback = safeGet(s, 'metrics.trade_count', 0);
const barsUsed       = safeGet(s, 'metrics.bars_used', 0);
const trades24h      = safeGet(s, 'intraday.trades_24h', null);
const lookbackTrades = sig.metrics?.trade_count ?? 0;
const trades24 = sig?.intraday?.trades_24h ?? 0;
card.querySelector(`#trades-${key}`).textContent = `${lookbackTrades} • 1d: ${trades24}`;

// Existing line for Trades:
row('Trades', fmt(tradesLookback));

// …or replace with a combined line:
row('Trades',
  trades24h != null
    ? `${fmt(tradesLookback)} <span class="muted">(last ${fmt(barsUsed)} bars)</span> • <b>${fmt(trades24h)}</b> <span class="muted">(24h)</span>`
    : `${fmt(tradesLookback)} <span class="muted">(last ${fmt(barsUsed)} bars)</span>`
);

  function fmtPct(x){ if(x==null||isNaN(x)) return "—"; return FMT_PCT.format(x); }
  function fmtPrice(x){ if(x==null||isNaN(x)) return "—"; return FMT4.format(x); }
  function fmtTs(s){ if(!s) return "—"; try{ return new Date(s).toLocaleString(); }catch{ return s; } }
  function fmtHold(mins){ if(mins==null||isNaN(mins)) return "—"; const h=Math.floor(mins/60), m=Math.round(mins%60); return (h?`${h}h `:"")+`${m}m`; }

  async function getJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url+': '+r.status); return r.json(); }
  async function getText(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url+': '+r.status); return r.text(); }

  async function loadSignals(){
    const sigs = await getJSON('/signals');
    const cardWrap = document.getElementById('cards'); cardWrap.innerHTML='';
    for(const [fname, obj] of Object.entries(sigs)){
      const m = obj.metrics || {};
      const header = `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <span class="chip">${obj.exchange||'?'}</span>
          <span class="chip">${obj.symbol||'?'}</span>
          <span class="chip">TF ${obj.interval||'?'}</span>
          <span class="chip">Strategy ${String(obj.chosen_strategy||'NONE').toUpperCase()}</span>
        </div>`;
      const body = `
        <div class="grid2">
          <div class="k">Signal</div><div class="v" style="color:${obj.signal==='LONG'?'#a9eec8':obj.signal==='SHORT'?'#ffb3b3':'#d7e0ea'}">${obj.signal||'—'}</div>
          <div class="k">Price</div><div class="v">${fmtPrice(obj.price)}</div>
          <div class="k">Sharpe (ann)</div><div class="v">${FMT.format(m.sharpe_ann??0)}</div>
          <div class="k">Max DD</div><div class="v">${fmtPct(m.max_drawdown??0)}</div>
          <div class="k">Win rate (bar)</div><div class="v">${fmtPct(m.win_rate_bar??0)}</div>
          <div class="k">Profit factor (bar)</div><div class="v">${FMT.format(m.profit_factor_bar??0)}</div>
          <div class="row">
            <div class="label">Trades</div>
            <div class="value" id="trades-${key}">
              <!-- filled by JS -->
            </div>
          </div>
        </div>`;
      let guardTxt='Selection OK', guardClass='chip good';
      if(obj.selection_guard && obj.selection_guard.passed===false){ guardTxt=obj.selection_guard.reason||'Selection blocked'; guardClass='chip bad'; }
      const rp=obj.regime_params||{};
      const chips = `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
          <span class="muted">AI assist:</span>
          <span class="muted">${(obj.ml && obj.ml.enabled) ? `${(obj.ml.vote||'on')} (p_up=${(obj.ml.p_up??0).toFixed(3)})` : 'off'}</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <span class="chip">WF train ${rp.wf_train??'-'}</span>
          <span class="chip">test ${rp.wf_test??'-'}</span>
          <span class="chip">step ${rp.wf_step??'-'}</span>
          <span class="chip">ADX th ${rp.adx_threshold??'-'}</span>
          <span class="chip">ADX len ${rp.adx_len??'-'}</span>
        </div>
        <div style="margin-top:12px;"><span class="${guardClass}">${guardTxt}</span></div>`;
      const foot = `<div class="footer">Updated: ${fmtTs(obj.generated_at)} · Metrics file: ${fname.replace('_signal.json','_metrics.csv')}</div>`;
      const card=document.createElement('div'); card.className='card'; card.innerHTML=header+body+chips+foot; cardWrap.appendChild(card);
    }

    // equity header from brain_metrics.csv if available
    const brainMetrics = await getText('/metrics/brain_metrics.csv?n=600').catch(()=> '');
    let deltaTxt = 'Δ 24h: —', total=0;
    if(brainMetrics){
      try{
        const lines=brainMetrics.trim().split('\n'); const hdr=lines.shift().split(',');
        const tsIdx=hdr.indexOf('ts'); const eqIdx=hdr.indexOf('paper_equity');
        const pts=lines.map(l=>l.split(',')).map(r=>({ts:new Date(r[tsIdx]), eq:parseFloat(r[eqIdx]||'0')})).filter(p=>isFinite(p.eq));
        if(pts.length){
          const last=pts[pts.length-1]; const since=Date.now()-24*3600*1000;
          const prev=pts.filter(p=>p.ts.getTime()>=since)[0] || pts[0];
          total = last.eq; const diff=last.eq - prev.eq; const pct = prev.eq ? diff/prev.eq : 0;
          deltaTxt = `Δ 24h: ${FMT4.format(diff)} (${(pct*100).toFixed(2)}%)`;
        }
      }catch(e){}
    }
    document.getElementById('equityTotal').textContent = FMT4.format(total||0);
    document.getElementById('equityDelta').textContent = deltaTxt;
    const bots = await getJSON('/signals').catch(()=> ({}));
    document.getElementById('botsCount').textContent = String(Object.keys(bots).length);
    document.getElementById('botsTime').textContent = new Date().toISOString();
  }
  async function drawEquitySpark() {
  const res = await fetch('/metrics/brain_metrics.csv?n=200');
  const csv = await res.text();
  const lines = csv.trim().split('\n').slice(1); // skip header
  const equity = lines.map(l => {
    const parts = l.split(',');
    return parseFloat(parts[parts.length - 1]); // assumes last column is equity
  }).filter(v => !isNaN(v));

  const canvas = document.getElementById('equitySpark');
  if (!canvas || equity.length < 2) return;
  const ctx = canvas.getContext('2d');

  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // normalize
  const w = canvas.width, h = canvas.height;
  const minV = Math.min(...equity), maxV = Math.max(...equity);
  const pad = 4;
  const scaleX = (w - 2*pad) / (equity.length - 1);
  const scaleY = (h - 2*pad) / (maxV - minV || 1);

  ctx.beginPath();
  equity.forEach((v, i) => {
    const x = pad + i*scaleX;
    const y = h - pad - (v - minV) * scaleY;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.lineWidth = 2;
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--fg') || '#a0b3d1';
  ctx.stroke();
}
drawEquitySpark();

  // Trades modal
  async function openTrades(){
    const data = await getJSON('/trades/last24h?pattern=*_ledger.csv');
    const s = data.closed_summary || {count:0,win_rate:0,pnl_sum:0,pnl_avg:0};
    const sum = document.getElementById('tradesSummary');
    sum.innerHTML = `
      As of ${new Date(data.as_of).toLocaleString()} · ${s.count} closed ·
      Win rate <b>${(s.win_rate*100).toFixed(1)}%</b> ·
      Total PnL <b class="${s.pnl_sum>=0?'pnl-pos':'pnl-neg'}">${(s.pnl_sum*100).toFixed(2)}%</b> ·
      Avg PnL <b class="${s.pnl_avg>=0?'pnl-pos':'pnl-neg'}">${(s.pnl_avg*100).toFixed(2)}%</b>
    `;

    // closed
    const tbody = document.querySelector('#tradesTable tbody'); tbody.innerHTML='';
    (data.closed||[]).forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${t.symbol}</td>
        <td class="${t.side==='LONG'?'side-long':'side-short'}">${t.side}</td>
        <td>${new Date(t.entry_time).toLocaleString()}</td>
        <td class="num">${fmtPrice(t.entry_price)}</td>
        <td>${new Date(t.exit_time).toLocaleString()}</td>
        <td class="num">${fmtPrice(t.exit_price)}</td>
        <td class="num ${t.pnl_pct>=0?'pnl-pos':'pnl-neg'}">${(t.pnl_pct*100).toFixed(2)}%</td>
        <td class="num">${fmtHold(t.holding_mins)}</td>`;
      tbody.appendChild(tr);
    });

    // open positions
    const obody = document.querySelector('#openTable tbody'); obody.innerHTML='';
    (data.open||[]).forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${p.symbol}</td>
        <td class="${p.side==='LONG'?'side-long':'side-short'}">${p.side}</td>
        <td>${new Date(p.entry_time).toLocaleString()}</td>
        <td class="num">${fmtPrice(p.entry_price)}</td>
        <td class="num">${fmtPrice(p.current_price)}</td>
        <td class="num ${p.unrealized_pct>=0?'pnl-pos':'pnl-neg'}">${(p.unrealized_pct*100).toFixed(2)}%</td>
        <td class="num">${fmtHold(p.holding_mins)}</td>`;
      obody.appendChild(tr);
    });

    document.getElementById('tradesBackdrop').style.display='flex';
  }

  function closeTrades(){ document.getElementById('tradesBackdrop').style.display='none'; }

  function exportTableToCSV(tblId, fname){
    const rows=[]; const heads=[...document.querySelectorAll(`#${tblId} thead th`)].map(th=>th.textContent.trim()); rows.push(heads.join(','));
    document.querySelectorAll(`#${tblId} tbody tr`).forEach(tr=>{
      const cols=[...tr.querySelectorAll('td')].map(td=>String(td.textContent).replace(/,/g,''));
      rows.push(cols.join(','));
    });
    const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  document.getElementById('btnRefresh').onclick = loadSignals;
  document.getElementById('btnTrades').onclick = openTrades;
  document.getElementById('btnCloseTrades').onclick = closeTrades;
  document.getElementById('btnCloseTrades2').onclick = closeTrades;
  document.getElementById('btnExportTrades').onclick = ()=>exportTableToCSV('tradesTable', `closed_trades_${new Date().toISOString().slice(0,19)}.csv`);
  document.getElementById('btnExportOpen').onclick = ()=>exportTableToCSV('openTable', `open_positions_${new Date().toISOString().slice(0,19)}.csv`);

  // auto refresh
  let timer=null;
  function setAuto(){ if(timer) clearInterval(timer); const sec=parseInt(document.getElementById('refreshSel').value,10); timer=setInterval(loadSignals, sec*1000); }
  document.getElementById('refreshSel').onchange = setAuto;

  loadSignals().then(setAuto);
</script>
</body>
</html>
